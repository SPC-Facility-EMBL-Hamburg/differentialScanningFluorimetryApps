---
output: 
  pdf_document:
    includes:
      in_header: header.tex
    keep_tex: true
    toc: false
title: \textbf{\textcolor{NavyBlue}{Protein Stability Report (Differential Scanning Fluorimetry)}}
date: "`r format(Sys.time(), '%F')`"
header-includes:
    - \usepackage{fancyhdr}
---

\fancyhf{}

\addtolength{\headheight}{0.4cm} 
\pagestyle{fancyplain}
\rhead{\includegraphics[height=1.2cm]{`r paste0(base_dir,"www/embl_logo.png")`}} 
\renewcommand{\headrulewidth}{0pt} 

\fontsize{14}{16}
\selectfont

\fancyfoot[CO,CE]{Automatic report provided by the SPC Facility, EMBL, Hamburg}
\fancyfoot[LE,RO]{\thepage}

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r, echo=FALSE,warning = FALSE}
reticulate::py_run_string("import sys")

# Remove previous plots

fs1 <- list.files(".",pattern = "*signal.png")
fs2 <- list.files(".",pattern = "*derivative.png")
fs3 <- list.files(".",pattern = "*max_der.png")
fs4 <- list.files(".",pattern = "*unfolded_resultsPlot.png")
fs5 <- list.files(".",pattern = "*tmPlot.png")

for (fn in c(fs1,fs2,fs3,fs4,fs5))  { file.remove(fn) }

```

## Input 

Files:                           `r input$dsf_files$name`
Signal:                         `r input$which`          
Median Filter:                  `r input$median_filter`              
Minimum Temperature:            `r min(input$sg_range)`             
Maximum Temperature:            `r max(input$sg_range)`         
Normalization:                  `r switch(input$normalization_type,"Raw_signal"="Raw Signal","Divide_by_init_value"="Divide by initial value","MC_Normalization"="Max-Min Normalization","area_Normalization"="Area Normalization")`       

```{r, eval=input$report_include_signal,tidy=FALSE,results='asis',echo=FALSE}
cat("## Fluorescence Signal \n")
```

<br><br>

```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center",eval=input$report_include_signal,include=TRUE}

fluo_m <- py_dsf_to_df(dsf)

fluo_m <- fluo_m %>% group_by(cond_) %>% nest()

splitted_conditions <- split_vec(fluo_m$cond_,20)

colors <- dsf$get_experiment_properties('colors',flatten=TRUE)
splitted_colors <- split_vec(colors,20)

i <- 0

for (split_cond in splitted_conditions) {

  i <- i+1
  
  temp_df <- fluo_m %>% filter(cond_ %in% split_cond) %>% unnest(cols = c(data)) %>% ungroup()

  p <- plot_fluo_signal(
    temp_df,
    splitted_colors[[i]],
    input$which,
    input$plot_width,
    input$plot_height,
    input$plot_type,
    input$plot_font_size,
    input$plot_axis_size)

  save_image(p, paste0(i,"signal.png"))

}
```

```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center",eval=input$report_include_signal}
files <- list.files(".",pattern = "*signal.png")
knitr::include_graphics(files)
```

```{r, eval=input$report_include_der,tidy=FALSE,results='asis',echo=FALSE}
cat("## First Derivative \n")
```

<br><br>
```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center",eval=input$report_include_der,include=FALSE}

fluo_m <- py_dsf_to_df(dsf,mode="derivative")
fluo_m <- fluo_m %>% group_by(cond_) %>% nest()

splitted_conditions <- split_vec(fluo_m$cond_,20)
colors <- dsf$get_experiment_properties('colors',flatten=TRUE)
splitted_colors <- split_vec(colors,20)

i <- 0
for (split_cond in splitted_conditions) {
  i <- i+1
  
  temp_df <- fluo_m %>% filter(cond_ %in% split_cond) %>% unnest(cols = c(data)) %>% ungroup()

  p <- plot_fluo_signal(
    temp_df,
    splitted_colors[[i]],
    "First derivative",
    input$plot_width,
    input$plot_height,
    input$plot_type,
    input$plot_font_size,
    input$plot_axis_size)


  save_image(p,paste0(i,"derivative.png"))
}
```

```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center",eval=input$report_include_der}
files <- list.files(".",pattern = "*derivative.png")
knitr::include_graphics(files)
```

```{r, eval=input$report_include_max_der,tidy=FALSE,results='asis',echo=FALSE}
cat("## Maxium of Derivative \n")
```

<br><br>
```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center",eval=input$report_include_max_der,include=FALSE}

conditions <- dsf$get_experiment_properties('conditions',flatten=TRUE)
splitted_conditions <- split_vec(1:length(conditions),20)

i <- 0
for (split_cond in splitted_conditions) {
  i <- i+1
  
  tms_from_deriv <- dsf$get_experiment_properties('tms_from_deriv',flatten=TRUE)
  conditions <- dsf$get_experiment_properties('conditions',flatten=TRUE)

  p <-  generate_max_der_plot(tms_from_deriv[split_cond],conditions[split_cond],
                             input$plot_width, input$plot_height, 
                             input$plot_type,input$plot_font_size,input$plot_axis_size)
  
  save_image(p,paste0(i,"max_der.png"))
}
```

```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center",eval=input$report_include_max_der}
files <- list.files(".",pattern = "*max_der.png")
knitr::include_graphics(files)
```

```{r, eval=input$report_include_fitted_params_table,tidy=FALSE,results='asis',echo=FALSE}
cat("## Fitted Parameters \n")
```

<br><br>
```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center", eval=input$report_include_fitted_params_table}

params_all <- dsf$get_experiment_properties('params_all',flatten=TRUE)
params_name <- dsf$get_experiment_properties('params_name',flatten=TRUE)
params_name <- unique(params_name)

fitted_conditions <- dsf$get_experiment_properties('fitted_conditions',flatten=TRUE)

table <- get_sorted_params_table(
  params_all,
  fitted_conditions,
  global_chunck_n,
  params_name,
  input$sort_table_parameter
)

knitr::kable(table)  
```

```{r, eval=input$report_include_fitted_params_errors_table,tidy=FALSE,results='asis',echo=FALSE}
cat("## Fitted Parameters Relative Errors (%) \n")
```

<br><br>

```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center", eval=input$report_include_fitted_params_errors_table}

errors_percentage_all <- dsf$get_experiment_properties('errors_percentage_all',flatten=TRUE)
fitted_conditions <- dsf$get_experiment_properties('fitted_conditions',flatten=TRUE)
params_name <- dsf$get_experiment_properties('params_name',flatten=TRUE)
params_name <- unique(params_name)

table <- get_sorted_params_table_errors(
  errors_percentage_all,
  fitted_conditions,
  params_name,
  input$sort_table_parameter)

last_col <- length(colnames(table))-1

colnames(table)[1:last_col] <- sapply(colnames(table)[1:last_col], function(x) {
  strsplit(x,"/")[[1]][2]
})

knitr::kable(table)

```

```{r, eval=input$report_include_fitting_plots,tidy=FALSE,results='asis',echo=FALSE}
cat("## Fitting Plots \n")
```

<br><br>
```{r, echo=FALSE,warning = FALSE,out.width = "100%",fig.align = "center" , eval=input$report_include_fitting_plots}

fitted_conditions <- dsf$get_experiment_properties('fitted_conditions',flatten=TRUE)
total_plots <- ceiling(length(fitted_conditions)/global_chunck_n)

for (selected in 1:total_plots) {
  real_data  <- reactives$fluo_fit_real
  model_data <- reactivesfluo_fit_pred
  grid.draw(plot_fluorescence_fit(real_data,model_data,selected,TRUE))
}

```

```{r, eval=input$report_include_results_plots,tidy=TRUE,results='asis',echo=FALSE}
cat("## Results Plot \n")

l1 <- paste0("For all fitted parameters: (Standard_deviation / value) * 100 < Threshold: " ,input$sd_factor_bool, "\n")
l2 <- paste0("Threshold: ",input$rel_error_threshold, "\n")
l3 <- paste0('Residuals threshold: ',input$residuals_threshold, "\n")

str_vec <- c(l1,l2,l3)

if (dsf$model_name %in% c("EmpiricalTwoState","EquilibriumTwoState")) {
  l4 <- paste0("Lower Tm filter: ",input$lower_Tm_threshold, "\n")
  l5 <- paste0("Upper Tm filter: ",input$upper_Tm_threshold, "\n")
  str_vec <- c(str_vec,l4,l5)
}

if (dsf$model_name %in% c("EquilibriumTwoState")) {
  l4 <- paste0("Lower DH filter: ",input$lower_dh_threshold, "\n")
  l5 <- paste0("Upper DH filter: ",input$upper_dh_threshold, "\n")
  str_vec <- c(str_vec,l4,l5)
}

if (dsf$model_name %in% c("EmpiricalThreeState","EquilibriumThreeState")) {
  l4 <- paste0("Lower T1 filter: ",input$lower_T1_threshold, "\n")
  l5 <- paste0("Upper T1 filter: ",input$upper_T1_threshold, "\n")
  str_vec <- c(str_vec,l4,l5)
}

if (dsf$model_name %in% c("EmpiricalThreeState","EquilibriumThreeState")) {
  l4 <- paste0("Lower T2 filter: ",input$lower_T2_threshold, "\n")
  l5 <- paste0("Upper T2 filter: ",input$upper_T2_threshold, "\n")
  str_vec <- c(str_vec,l4,l5)
}

cat(str_vec,sep="\n")

```

<br><br>

```{r, echo=FALSE,warning = FALSE,eval=input$report_include_results_plots,include=FALSE}

selected_indexes <- filter_conditions()

params_name <- dsf$get_experiment_properties('params_name',flatten=TRUE)
params_name <- unique(params_name)

params_all <- dsf$get_experiment_properties('params_all',flatten=TRUE)

fitted_conditions <- dsf$get_experiment_properties('fitted_conditions',flatten=TRUE)

if (any(selected_indexes) & input$model_selected == "EquilibriumTwoState") {
  dh_position <- which(params_name == "DH")
  dhs <- sapply(params_all, function(x) x[dh_position])
  
  tm_position <- which(params_name == "Tm")  
  tms <- sapply(params_all, function(x) x[tm_position])
  
  T_onset <- dsf$get_experiment_properties('T_onset',flatten=TRUE)

  dhs               <- dhs[selected_indexes]
  tms               <- tms[selected_indexes]
  fitted_conditions <- fitted_conditions[selected_indexes]
  t_onset           <- T_onset[selected_indexes]
  
  splitted_conditions <- split_vec(1:length(fitted_conditions),20)
  
  i <- 0
  for (split_cond in splitted_conditions) {
    
    i <- i+1
    
    fig <- generate_fractions_plot(
      dhs[split_cond],tms[split_cond],fitted_conditions[split_cond],t_onset[split_cond],
      input$plot_width_results,input$plot_height_results,input$plot_type_results,
      input$plot_font_size_results,input$plot_axis_size_results)
    
    save_image(fig,paste0(i,"fraction_unfolded_resultsPlot.png"))
}

}

```

```{r echo=FALSE, out.width = "100%", fig.align="center", warning=FALSE, eval=(length(list.files(".",pattern = "*resultsPlot.png"))>0)}

files <- list.files(".",pattern = "*resultsPlot.png")
knitr::include_graphics(files)

```

```{r, echo=FALSE,warning = FALSE,eval=input$report_include_results_plots,include=FALSE}

if (any(selected_indexes) & (input$model_selected %in% c("EquilibriumTwoState","EmpiricalTwoState"))) {


  params_name <- dsf$get_experiment_properties('params_name',flatten=TRUE)
  params_name <- unique(params_name)

  params_all <- dsf$get_experiment_properties('params_all',flatten=TRUE)

  fitted_conditions <- dsf$get_experiment_properties('fitted_conditions',flatten=TRUE)

  tm_position <- which(params_name == "Tm")  
  tms <- sapply(params_all, function(x) x[tm_position])
  
  tms               <- tms[selected_indexes]
  fitted_conditions <- fitted_conditions[selected_indexes]
  
  splitted_conditions <- split_vec(1:length(fitted_conditions),20)
  i <- 0
  for (split_cond in splitted_conditions) {
    
    i <- i+1
    
    fig <- generate_tm_plot(tms[split_cond],fitted_conditions[split_cond],
                        input$plot_width_results, input$plot_height_results, 
                        input$plot_type_results,input$plot_axis_size_results)
    
    save_image(fig,paste0(i,"tmPlot.png"))
  }
  
}

```

```{r echo=FALSE, out.width = "100%", fig.align="center", warning=FALSE, eval=(length(list.files(".",pattern = "*tmPlot.png"))>0)}
files <- list.files(".",pattern = "*tmPlot.png")
knitr::include_graphics(files)

```
  

